name: Plugin Submission CI

on:
  pull_request_target:
    paths:
      - 'submissions/**'

jobs:
  validate:
    name: Validate Submission
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Find changed submission directory
        id: find
        run: |
          CHANGED=$(git diff --name-only origin/main...${{ github.event.pull_request.head.sha }} | grep '^submissions/' | grep -v '^submissions/\.example' | head -1)
          if [ -z "$CHANGED" ]; then
            echo "No submission changes detected."
            exit 0
          fi
          PLUGIN_DIR=$(echo "$CHANGED" | cut -d'/' -f1-2)
          PLUGIN_ID=$(echo "$PLUGIN_DIR" | cut -d'/' -f2)
          echo "plugin_dir=$PLUGIN_DIR" >> $GITHUB_OUTPUT
          echo "plugin_id=$PLUGIN_ID" >> $GITHUB_OUTPUT
          echo "Detected plugin: $PLUGIN_ID"

      - name: Check required files
        if: steps.find.outputs.plugin_dir != ''
        run: |
          PLUGIN_DIR="${{ steps.find.outputs.plugin_dir }}"
          MISSING=()
          for f in submission.json plugin.manifest.json plugin.boot.yml config.boot.json; do
            if [ ! -f "$PLUGIN_DIR/$f" ]; then
              MISSING+=("$f")
            fi
          done
          if [ ${#MISSING[@]} -ne 0 ]; then
            echo "::error::Missing required files: ${MISSING[*]}"
            exit 1
          fi
          echo "All required files present."

      - name: Validate submission.json
        if: steps.find.outputs.plugin_dir != ''
        run: |
          pip install jsonschema --quiet
          python3 - <<EOF
          import json, sys

          with open("${{ steps.find.outputs.plugin_dir }}/submission.json") as f:
              data = json.load(f)

          required = ["pluginId", "version", "developerGitHub", "sourceRepo", "sourceCommit", "mainServiceDockerfile", "submittedAt", "changelog"]
          missing = [k for k in required if not data.get(k)]
          if missing:
              print(f"::error::submission.json missing required fields: {missing}")
              sys.exit(1)

          if len(data["sourceCommit"]) != 40:
              print("::error::sourceCommit must be a full 40-character commit hash.")
              sys.exit(1)

          print("submission.json validation passed.")
          EOF

      - name: Validate plugin.manifest.json
        if: steps.find.outputs.plugin_dir != ''
        run: |
          python3 - <<EOF
          import json, sys

          with open("${{ steps.find.outputs.plugin_dir }}/plugin.manifest.json") as f:
              manifest = json.load(f)

          with open("${{ steps.find.outputs.plugin_dir }}/submission.json") as f:
              submission = json.load(f)

          required = ["griffinoPluginManifestVersion", "id", "version", "name", "description",
                      "author", "license", "configurationFiles", "capabilities"]
          missing = [k for k in required if k not in manifest]
          if missing:
              print(f"::error::plugin.manifest.json missing required fields: {missing}")
              sys.exit(1)

          if manifest["id"] != submission["pluginId"]:
              print(f"::error::manifest.id ({manifest['id']}) does not match submission.pluginId ({submission['pluginId']})")
              sys.exit(1)

          if manifest["version"] != submission["version"]:
              print(f"::error::manifest.version ({manifest['version']}) does not match submission.version ({submission['version']})")
              sys.exit(1)

          if not manifest.get("capabilities"):
              print("::error::plugin.manifest.json must declare at least one capability.")
              sys.exit(1)

          print("plugin.manifest.json validation passed.")
          EOF

      - name: Fetch approved image whitelist
        if: steps.find.outputs.plugin_dir != ''
        run: |
          curl -sf https://raw.githubusercontent.com/GriffinGuard/griffino-plugins/main/approved-images.json \
            -o approved-images.json
          echo "Fetched approved-images.json from griffino-plugins."

      - name: Check image whitelist
        id: image_check
        if: steps.find.outputs.plugin_dir != ''
        run: |
          pip install pyyaml --quiet
          python3 - <<EOF
          import json, yaml, sys, os

          with open("approved-images.json") as f:
              approved = {img["image"] for img in json.load(f)["approvedImages"]}

          with open("${{ steps.find.outputs.plugin_dir }}/plugin.boot.yml") as f:
              boot = yaml.safe_load(f)

          unapproved = []
          for svc_id, svc in boot.get("services", {}).items():
              image = svc.get("image", "")
              if image.startswith("ghcr.io/griffinguard/"):
                  continue
              if image and image not in approved:
                  unapproved.append(image)

          if unapproved:
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write(f"unapproved_images={','.join(unapproved)}\n")
                  f.write("has_unapproved=true\n")
              print(f"Unapproved images detected: {unapproved}")
          else:
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("has_unapproved=false\n")
              print("All auxiliary images are on the approved whitelist.")
          EOF

      - name: Comment unapproved images warning
        if: steps.image_check.outputs.has_unapproved == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const images = '${{ steps.image_check.outputs.unapproved_images }}'.split(',');
            const list = images.map(img => `- \`${img}\``).join('\n');
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ⚠️ Unapproved Auxiliary Images\n\nThe following images are not on the approved whitelist and require Maintainer review before this PR can be approved:\n\n${list}\n\nPlease verify the source, Dockerfile, and publisher reputation of these images before approving.`
            });

      - name: Summary
        if: steps.find.outputs.plugin_dir != ''
        run: |
          echo "## CI Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Plugin ID:** ${{ steps.find.outputs.plugin_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.image_check.outputs.has_unapproved }}" == "true" ]; then
            echo "⚠️ Unapproved auxiliary images detected — Maintainer image review required." >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ All auxiliary images are approved." >> $GITHUB_STEP_SUMMARY
          fi
          echo "✅ All format checks passed." >> $GITHUB_STEP_SUMMARY
